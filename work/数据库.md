# 数据库

## 连接数据库

```shell
## 远程
sqlplus username/password@ipaddress:port/SID (as sysdba)
## 如果有tnsname
sqlplus username/password@tnsname
## local
sqlplus / as sysdba

## 连接asm
su - grid
sqlplus / as sysasm
```

## 配置TNS name

```shell
su - oracle
cd $ORACLE_HOME/network/admin
vim tnsnames.ora
```

## 配置Listener

```shell
su - oracle
cd $ORACLE_HOME/network/admin
vim listener.ora

## 开启监听
lsnrctl start Listener_name
## 停止监听
lsnrctl stop Listener_name
```
## GRID 用户
### 启动asm

```shell
srvctl  start asm
```

> 由于startup；命令失败，使用此命令启动asm
>
> **SQL> startup;**
>
> ORA-01078: failure in processing system parameters
>
> ORA-29701: unable to connect to Cluster Synchronization Service

### 查看资源状态

```shell
crsctl stat res -t
```
## SQL

### 启动数据库

| 命令                 | 结果                |
| -------------------- | ------------------ |
| startup;             | 开启OPEN模式        |
| startup nomount;     | 开启nomount 模式    |
| startup mount;       | 开启 mount 模式     |
| startup open;        | 与startup相同；     |
| startup restrict     | 只允许特定用户访问    |
| startup pfile='file' | 带初始化参数启动      |

### 关闭数据库

| 命令                    | 结果                                    |
| ----------------------- | -------------------------------------- |
| shutdown normal;        | 需要等待所有的用户断开连接                 |
| shutdown immediate;     | 等待用户完成当前的语句后马上关闭数据库       |
| shutdown transactional; | 等待用户完成当前的事务                    |
| shutdown abort;         | 不做任何等待，直接关闭数据库               |

### 查看用户

```sql
select username, password from dba_users;
```

### 修改密码

```sql
alter user username identified by password;
```


### 查看数据库状态

| 启动状态 | 命令                              | 结果                         |
| -------- | --------------------------------- | ---------------------------- |
| nomount  | select status from v$instance;    | STARTED                      |
| nomount  | select open_mode from v$database; | ERROR,  database not mounted |
| mount    | select status from v$instance;    | MOUNTED                      |
| mount    | select open_mode from v$database; | MOUNTED                      |
| open     | select status from v$instance;    | OPEN                         |
| open     | select open_mode from v$database; | READ WRITE 或者 READ ONLY    |


### 测试数据库监听

```shell
su - oracle
tnsping 10.210.149.141:1526/ora11g
```

### 查看和更改数据库状态

```sql
select status from v$instance;
startup nomount;
alter database mount;
alter database open;
```

### spfile 和 pfile

参数文件位置：

```sql
show parameter spfile;
```



转换参数文件：

```sql
create pfile [='file'] from spfile [='file']
create spfile [='file'] from pfile [='file']
```

> 参数文件的搜索顺序：
>
> `spfile<sid>.ora ` > `spfile.ora` > `init<sid>.ora ` 
>
> **PS: 如果不指定路径， 都会生成到`$ORACLE_HOME/dbs`路径**



## 日志

Alert log 文本文件位置:
```sql
select value from v$diag_info where name ='Diag Trace';
```
alert log  XML 文件位置：
```sql
select value from v$diag_info where name ='Diag Alert';
```



## 修改DB_NAME

1. 通过spfile创建pfile

   ```sql
   SQL> create pfile='/tmp/pfile.ora' from spfile;
   ```

2. 停止数据库

   ```sql
   SQL> shutdown immediate;
   ```

3. mount状态启动数据库

   ```sql
   SQL> startup mount;
   ```

4. 使用nid工具修改db_name

   ```shell
   oracle$: nid target=/ dbname='newname' setname='yes'
   ```

   > ```
   > nid target=sys/password # 此方式是僅僅修改dbid
   > nid target=/ dbname=new_dbname [setname=yes]#连接当前sid，并修改dbname
   > nid target=sys/password dbname=new_dbname [setname=yes]
   > # setname=yes 僅僅修改數據庫名字，如果省略，則兩者同時修改
   > nid target=sys/pwdd@conn_string dbname=new_dbname [setname=yes] # 修改远程主机
   > ```

5. 创建密码文档

   ```shell
   oracle$: orapwd file='orapw + dbname' password='new password'
   ```
   > 修改后可以删除原密码文档

6. 修改pfile中的dbname

7. 通过pfile创建spfile

   ```sql
   SQL> create spfile from pfile='/tmp/pfile.ora';
   ```

8. 启动数据库

   ```sql
   SQL> startup;
   ```
   
操作代码：

```shell
su - oracle
create pfile='/tmp/pfile.ora' from spfile;
shutdown immediate;
startup mount;
exit
########################
nid target=/ dbname='ora11g' setname='yes'
cd $ORACLE_HOME/dbs
orapwd file='orapwora11g' password='Oracle_1'
vi /tmp/pfile.ora
########################
sqlplus / as sysdba
create spfile='+DG_ORA/drora11g/spfiledrora11g.ora' from pfile='/tmp/pfile.ora';
startup;
```





## 安装配置DataGuard

1. 检查生产容灾数据库配置
2. 修改db_name
3. 创建并配置双机浮动ip资源
4. 建立oracle用户相互信任关系
5. 去除备机对主机信任关系
6. 停止双机监控
7. 创建DataGuard任务
8. 执行

**注意：spfile位置必须为 `+DG_ORA/drora11g/spfiledrora11g.ora`**