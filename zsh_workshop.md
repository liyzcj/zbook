# Zsh Workshop

## 介绍

　　所有用户与 UNIX 系统交互的方式都是他们的SHELL。SHELL 为用户运行程序，从运行中的进程导入或导出数据。它给了用户一个完成 UNIX 工作的环境。

　　如果配置正确，UNIX SHELL 会让系统使用起来更加方便和简单。如果你的 SHELL 没有按照你的喜好来配置，使用它可能会导致效率大大降低，令人头疼，并且有时候会产生有害的、意想不到的效果。

　　**本书并不是试图让你使用zsh。**如果你已经使用一个 SHELL 15年了，你需要一个更好地理由将它换为 zsh。（也许本书会为你提供一点点）

　　本书的目的是**如何使用zsh让你的 UNIX 体验更加高效和愉快**。我会告诉你很多操作和配置zsh的方法。
　　
　　本书主要分为三个部分：
　　- 配置————让 zsh 的行为完全符合你希望的方式。
　　- 编程————利用一切可能充分利用脚本和函数。
　　- 技巧————大量的操作技巧和方法。

### 为什么选择 zsh？

　　Zsh 可以说是**最强大的和可配置的** UNIX SHELL。如果有的话，只有极少的事情其他 SHELL 可以做而 zsh 不能做。这也是为什么本书推荐 zsh 的原因。

　　简而言之，它可以让你用更少的时间完成更多的工作。

#### 特色

　　下面是一些 zsh 的特色。

<TABLE>
<TR COLSPAN=3>
<TD>别名
<TD>任务控制
<TD>函数

<TR>
<TD>简单灵活的 I/O 控制
<TD>目录堆栈
<TD>命令历史

<TR>
<TD>命令行编辑(vi, emacs, 自定义)
<TD>完全键盘映射
<TD>查找用户名

<TR>
<TD>登录/注销控制
<TD>高级文件名补全
<TD>主机名补全

<TR>
<TD>用户名补全
<TD>历史补全
<TD>完全编程补全

<TR>
<TD>SHELL受限模式
<TD>协同进程
<TD>内置算法评估

<TR>
<TD>隐藏符号链接
<TD>本地变量
<TD>定时命令

<TR>
<TD>简单可扩展提示符
<TD>拼写纠正
<TD>进程替换

<TR>
<TD>底层 sh 语法
<TD>处理大参数列表
<TD>避免用户setup file

<TR>
<TD>列出变量
<TD>全局别名
<TD>信号陷阱处理
</TABLE>

### 本书不包括

Zsh 的优点并不能简单的描述完全。以下是并不包含的内容，如果你对这些感兴趣，你可以自己去研究：

- 扩展参数标志

有很多方法可以获得 zsh 的扩展参数。比如

```shell
man zshexpn
```

- 命令行编辑

Zsh 的命令行编辑完全支持编程和绑定。你可以写自己的函数来控制光标和命令行的内容。zsh 还支持 **emacs**，**vi** 命令。执行以下命令了解详细信息：

```shell
man zshzle
```

- 动态加载模块

你可以编写自己的函数并实时的添加它。Zsh 中的许多东西都是作为模块实现的，例如完成控制。执行如下命令了解详细信息：

```shell
man zshmodules
```

- 构造语法

很遗憾我没有时间完成控制编程这部分。 例如 if for which case 等等。也许这部分会以后添加。

## 配置 ZSH

### 初始文件

像许多的 SHELL 一样，zsh 处理许多系统和用户的初始配置文件。了解这些文件的读取顺序和导致文件被忽略的情况非常重要。否则，你的命令或者起始配置文件可能不会被 zsh 执行。

#### 启动过程

在下面的描述中，zsh 默认会查找用户家目录下的配置文件。如果你希望它查找其他目录的配置文件，将参数 ZDOTDIR 设置为你想要的目录。

当 zsh 启动时，以下文件会被读取：

1. 读取 **/etc/zshenv**

如果在 **/etc/zshenv** 中未设置 **RCS** 选项，所有其他文件都会被跳过。

2. 读取 **~/.zshenv**
3. 如果 SHELL 为 login shell，读取 **/etc/zprofile**,然后是**~/.zprofile**
4. 如果 SHELL 为交互 SHELL ，读取 **/etc/zshrc**，然后是**~/.zshrc**
5. 最后，如果为 login shell，读取 **/etc/zlogin**，然后是 **~/.zlogin**
6. 当用户注销时，读取 **/etc/zlogout**，然后是 **~/.zlogout**

#### 术语解释

- **login shell**：登录 shell 一般在登录时产生，即当你使用 /bin/login 或者其他接入程序时，例如 SSH、rlogin、telnet等。例如：

```shell
ssh HOST_NAME SOME_COMMAND
```

即启动一个登录 shell

- **交互 SHELL ：交互 SHELL 是一个会显示提示并允许用户使用命令交互的 SHELL。

#### 注意

除了 /etc 还有**另一个**目录可以作为全局配置读取。可以再安装时确定。

### 通过选项配置 zsh

Zsh 有超过**一百多**个选项来控制 zsh 各方面的行为。每个选项都有一个名字，可以被打开或者关闭。

Zsh 提供了一些方法来打开或者关闭这些选项。最简单的可能是下面这个：

```shell
setopt OPTION_NAME   # 打开选项
unsetopt OPTION_NAME # 关闭选项
```

Zsh 的选项是大小写不敏感的，并且下划线会被忽略。这样可以使选项的名字简答易读。按照惯例一般全部大写。

任何一个选项都可以在前面加上 'NO' 来关闭。例如，如果你想关闭蜂鸣声，可以使用如下命令：

```shell
setopt NO_BEEP
```

有一些选项其实是其他选项的替代名称。这样有助于向后兼容 BASH 或者 KSH。（详情见手册）

### 提示符

Zsh 的提示符是**完全**可配置的。事实上，zsh 的提示符会获得它们自己的扩展类型。（如果你想在其他字符串上使用提示扩展，只需要 **-P** 参数指向 zsh 的内建函数 **print**）

Zsh 的**主要**提示符串包含在 SHELL 变量的 **PROMPT**中。这个变量也被称为 **PS1**。(它们是完全相同的，设置一个会影响另一个)

在 zsh 实际显示它们之前，提示符首先进行参数扩展，命令替换和算法扩展。（只有当 **PROMPT_SUBST** 选项打开时）

- 定制提示符

有些时候，每个人都想要定制自己独特的提示符。在 zsh 中有超过40个特殊的转移序列，允许你控制提示符中需要显示的信息。

像大多数 SHELL 一样，zsh 允许你在提示符中显示各种信息。当前时间、日期、主机信息或者当前目录等等。

Zsh 可以更进一步。它允许你截断你的提示，以便于它只占用命令行上一定的空间。它还为每个可显示的信息提供了许多不同的选项。它可以通过 **strftime(3)** 函数打印时间和日期。Zsh 在提示符中还支持 **“条件表示”**。这表示 zsh 可以根据特定的条件显示不同的提示信息。

在下面几个部分中，我们将讨论**所有可以使用的工具**来自定义你的提示符。

#### 在提示符中显示转移序列

通过特殊的**转义字符**定制你的提示符是非常简单但是重要的方法，有许多的**转义字符**代表不同的信息。大部分转移字符由符号**'%'**开始。然后，在 **PROMPT** 变量内，每一个转移字符都会由它们代表的信息代替。

一些转移字符可以使用可选的**整型参数**，它紧跟在**'%'***符号**之后**并在转移字符**之前**。

**转移序列和描述**

左边是转移字符，右边是它们代表的信息。

**注意**：新的转义字符可能会在以后添加。参考以下手册获取最新列表：

```shell
man zshmisc
```
- 字符

| 转义字符 | 代表信息 |
| -------- | -------- |
| %%       | %        |
| %)       | )        |

- 目录

| 转义字符 | 代表信息                              |
| -------- | ------------------------------------- |
| %d       | 当前目录-%PWD                         |
| %/       | 和%d相同                              |
| %~       | %PWD, 如果为%HOME，显示~              |
| %c       | PWD尾部组件。若想添加n个组件，使用%nc |
| %.       | 和%c相同                              |
| %C       | 与%c，%.相似，除了~不显示目录名称     |

- 主机名信息

| 转义字符 | 代表信息                               |
| -------- | -------------------------------------- |
| %M       | 全部主机名                             |
| %m       | 主机名到第一个'.' 可以使用%nm代表第n个 |

- 当前时间信息

| 转义字符 | 代表信息                      |
| -------- | ----------------------------- |
| %t       | 当前时间，12小时制，AM/PM格式 |
| %@       | 与%t相同                      |
| %T       | 当前时间，24小时制            |
| %\*      | 当前时间，24小时制，包含秒    |

- 当前日期

| 转义字符   | 代表信息                       |
| ---------- | ------------------------------ |
| %w         | 当前日期，day-dd 格式          |
| %W         | 当前日期，mm/dd/yy格式         |
| %D         | 当前日期，yy-mm-dd格式         |
| %D{string} | 字符串使用strftime函数格式化。 |

- 杂项

| 转义字符 | 代表信息                                |
| -------- | --------------------------------------- |
| %h       | 当前历史时间编号                        |
| %!       | 与%h相同                                |
| %L       | %SHLVL 的值                             |
| %n       | 等于 %USERNAME                          |
| %l       | 用户登录的行（tty）                     |
| %?       | 最后一个命令的返回码                    |
| %\_      | if for while 等等                       |
| %E       | 清除至行尾                              |
| %#       | 如果shell使用权限运行就是'#'，否则是‘%‘ |
| %v       | psvar数组参数的第一个元素的值           |

